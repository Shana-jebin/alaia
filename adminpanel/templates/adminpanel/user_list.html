{% extends 'adminpanel/base_admin.html' %}
{% load static %}
{% block page_title %}
  User Management
{% endblock %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'adminpanel/user-management.css' %}" />
{% endblock %}

{% block content %}
  <div class="search-filter-row">
    <form method="GET" id="searchForm" class="search-box">
      <input type="text" name="q" id="searchInput" value="{{ query }}" placeholder="Search users..." />

      {% if query %}
        <a href="{% url 'user_management' %}" class="clear-btn">✕</a>
      {% endif %}
    </form>
  </div>

  <div class="users-table">
    <table>
      <thead>
        <tr>
          <th>User</th>
          <th>Status</th>
          <th>Joined</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in page_obj %}
          <tr>
            <td>
              <div class="user-cell">
                <div class="user-avatar">{{ user.username|first|upper }}</div>
                <div class="user-info">
                  <div class="user-name">{{ user.get_full_name|default:user.username }}</div>
                  <div class="user-email">{{ user.email }}</div>
                </div>
              </div>
            </td>

            <td>
              {% if user.is_active %}
                <span class="status-badge status-active">
                  <span class="status-dot"></span>
                  Active
                </span>
              {% else %}
                <span class="status-badge status-blocked">
                  <span class="status-dot"></span>
                  Blocked
                </span>
              {% endif %}
            </td>

            <td class="joined-date">{{ user.date_joined|date:'M d, Y' }}</td>
            <td>
              <button type="button" class="action-btn block-btn" onclick="openModal('{% url 'toggle_block_user' user.id %}', '{{ user.username|escapejs }}', '{{ user.is_active }}')">
                {% if user.is_active %}
                  Block
                {% else %}
                  Unblock
                {% endif %}
              </button>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" style="text-align:center;">No users found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="pagination">
      {% if page_obj.has_previous %}
        <a href="{% url 'user_management' %}?page={{ page_obj.previous_page_number }}{% if query %}
            &q={{ query }}
          {% endif %}"
          class="page-btn">
          ‹
        </a>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
          <span class="page-btn active">{{ num }}</span>
        {% else %}
          <a href="{% url 'user_management' %}?page={{ num }}{% if query %}
              &q={{ query }}
            {% endif %}"
            class="page-btn">
            {{ num }}
          </a>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <a href="{% url 'user_management' %}?page={{ page_obj.next_page_number }}{% if query %}
            &q={{ query }}
          {% endif %}"
          class="page-btn">
          ›
        </a>
      {% endif %}
    </div>
  </div>

  <!-- Block/Unblock Modal -->
  <div id="blockModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Block User</h2>
        <button class="close-button" onclick="closeModal()">✕</button>
      </div>

      <div class="modal-body">
        <div class="user-info">
          <div class="icon-container">
            <!-- your SVG here -->
          </div>
          <div class="user-details">
            <div class="user-question" id="modalQuestion"></div>
            <div class="user-description">This user will no longer be able to access their account or make purchases.</div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="button button-cancel" onclick="closeModal()">Cancel</button>

        <form id="blockForm" method="POST">
          {% csrf_token %}
          <button type="submit" class="button button-block" id="confirmBtn">Confirm</button>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    function openModal(url, username, isActive) {
      const modal = document.getElementById('blockModal')
      const question = document.getElementById('modalQuestion')
      const form = document.getElementById('blockForm')
      const confirmBtn = document.getElementById('confirmBtn')
      const title = document.getElementById('modalTitle')
    
      if (isActive === 'True') {
        title.innerText = 'Block User'
        question.innerText = `Block ${username}?`
        confirmBtn.innerText = 'Block User'
      } else {
        title.innerText = 'Unblock User'
        question.innerText = `Unblock ${username}?`
        confirmBtn.innerText = 'Unblock User'
      }
    
      form.action = url
      modal.style.display = 'flex'
    }
    
    function closeModal() {
      document.getElementById('blockModal').style.display = 'none'
    }
    const searchInput = document.getElementById('searchInput')
    const searchForm = document.getElementById('searchForm')
    
    let typingTimer
    const delay = 500
    
    if (searchInput) {
      searchInput.addEventListener('keyup', function () {
        clearTimeout(typingTimer)
    
        typingTimer = setTimeout(() => {
          searchForm.submit()
        }, delay)
      })
    }
  </script>
{% endblock %}
