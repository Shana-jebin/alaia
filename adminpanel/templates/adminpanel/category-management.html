{% extends 'adminpanel/base_admin.html' %}
{% load static %}
{% block page_title %}
  category Management
{% endblock %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'adminpanel/category-management.css' %}" />
{% endblock %}

{% block content %}
  <div class="header-top">
    <h1>Category Management</h1>
    <a href="{% url 'admin_category_add' %}" class="btn-add-category">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
      </svg>Add Category
    </a>
  </div>
  <form method="GET">
    <input 
        type="text" 
        name="q" 
        value="{{ query }}" 
        class="search-bar" 
        placeholder="Search categories..."
    >
</form>


  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Category Name</th>
          <th>Slug</th>
          <th>Offer (%)</th>
          <th>Created Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for category in page_obj %}
          <tr>
            <td class="category-name">{{ category.name }}</td>
            <td class="slug">{{ category.slug }}</td>
            <td class="offer">
              {% if category.offer_percentage %}
                {{ category.offer_percentage }}%
              {% else %}
                -
              {% endif %}
            </td>
            <td class="date">{{ category.created_at|date:'M d, Y' }}</td>
            <td>
              <div class="status {% if not category.is_active %}deleted{% endif %}">
                <span class="status-dot"></span>
                <span class="status-text">
                  {% if category.is_active %}
                    Active
                  {% else %}
                    Inactive
                  {% endif %}
                </span>
              </div>
            </td>
            <td>
              <div class="actions">
                <button 
    type="button"
    class="btn-icon btn-edit"
    data-id="{{ category.id }}"
    data-name="{{ category.name }}"
    data-offer="{{ category.offer_percentage }}"
    data-status="{{ category.is_active }}"
    onclick="openEditModal(this)">
    ‚úè
</button>
                <form method="POST" action="{% url 'admin_category_delete' category.id %}" style="display:inline;">
    {% csrf_token %}
    <button type="submit" class="btn-icon btn-delete">üóë</button>
</form>

              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="6" style="text-align:center; padding:30px;">No categories found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="modal-overlay" id="addCategoryModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Add New Category</h2>
        <button class="btn-close" onclick="closeModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{% url 'admin_category_add' %}">
    {% csrf_token %}


          <div class="form-group">
            <label>Category Name<span class="required">*</span></label>
            <input type="text" name="name" class="form-control" required />

<textarea name="description" class="form-control" placeholder="Brief description..."></textarea>

<input type="number" name="offer_percentage" class="form-control" min="0" max="100" />

<select name="is_active" class="form-control" required>
    <option value="True">Active</option>
    <option value="False">Inactive</option>
</select>

          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea class="form-control" id="description" placeholder="Brief description..."></textarea>
          </div>
          <div class="form-group">
            <label>Offer (%)</label>
            <input type="number" class="form-control" id="offer" min="0" max="100" placeholder="Enter offer percentage" />
          </div>
          <div class="form-group">
            <label>Status<span class="required">*</span></label>
            <select class="form-control" id="status" required>
              <option value="">Select Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Add Category</button>

      </div>
    </div>
  </div>

  <!-- Edit Category Modal -->
  <div class="modal-overlay" id="editCategoryModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Edit Category</h2>
        <button class="btn-close" onclick="closeEditModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form method="POST" id="editCategoryForm">
    {% csrf_token %}

          <div class="form-group">
            <label>Category Name<span class="required">*</span></label>
            <input type="text" class="form-control" id="editCategoryName" required />
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea class="form-control" id="editDescription" placeholder="Brief description..."></textarea>
          </div>
          <div class="form-group">
            <label>Offer (%)</label>
            <input type="number" class="form-control" id="editOffer" min="0" max="100" placeholder="Enter offer percentage" />
          </div>
          <div class="form-group">
            <label>Status<span class="required">*</span></label>
            <select class="form-control" id="editStatus" required>
              <option value="">Select Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-cancel" onclick="closeEditModal()">Cancel</button>
        <button class="btn btn-primary" onclick="updateCategory()">Update Category</button>
      </div>
    </div>
  </div>

  <!-- Delete Category Modal -->
  <div class="modal-overlay" id="deleteCategoryModal">
    <div class="modal modal-delete">
      <div class="modal-header">
        <h2>Delete Category</h2>
        <button class="btn-close" onclick="closeDeleteModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="delete-warning">
          <div class="warning-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
          </div>
          <div class="warning-content">
            <h3 id="deleteWarningTitle">Are you sure you want to delete "Leather"?</h3>
            <p id="deleteWarningText">This category contains 124 products. This action cannot be undone.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-cancel" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn btn-danger" onclick="confirmDelete()">Delete Category</button>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
   function openEditModal(button) {

    const id = button.dataset.id;
    const name = button.dataset.name;
    const offer = button.dataset.offer || "";
    const status = button.dataset.status === "True" ? "True" : "False";

    // Fill form values
    document.getElementById('editCategoryName').value = name;
    document.getElementById('editOffer').value = offer;
    document.getElementById('editStatus').value = status;

    // Set form action dynamically
    document.getElementById('editCategoryForm').action =
        `/admin-panel/category/edit/${id}/`;

    // Open modal
    document.getElementById('editCategoryModal').classList.add('active');
}

    function openModal() {
      document.getElementById('addCategoryModal').classList.add('active')
      document.body.style.overflow = 'hidden'
    }
    
    function closeModal() {
      document.getElementById('addCategoryModal').classList.remove('active')
      document.body.style.overflow = 'auto'
      document.getElementById('categoryForm').reset()
    }
    
   
    function closeEditModal() {
      document.getElementById('editCategoryModal').classList.remove('active')
      document.body.style.overflow = 'auto'
      document.getElementById('editCategoryForm').reset()
    }
    
    function openDeleteModal(categoryName, productCount, row) {
      document.getElementById('deleteCategoryModal').classList.add('active')
      document.body.style.overflow = 'hidden'
    
      // Update delete modal content
      document.getElementById('deleteWarningTitle').textContent = `Are you sure you want to delete "${categoryName}"?`
      document.getElementById('deleteWarningText').textContent = `This category contains ${productCount} products. This action cannot be undone.`
    
      categoryToDelete = row
    }
    
    function closeDeleteModal() {
      document.getElementById('deleteCategoryModal').classList.remove('active')
      document.body.style.overflow = 'auto'
      categoryToDelete = null
    }
    
    
    
    // Close modal when clicking outside
    document.getElementById('addCategoryModal').addEventListener('click', (e) => {
      if (e.target.id === 'addCategoryModal') {
        closeModal()
      }
    })
    
    document.getElementById('editCategoryModal').addEventListener('click', (e) => {
      if (e.target.id === 'editCategoryModal') {
        closeEditModal()
      }
    })
    
    document.getElementById('deleteCategoryModal').addEventListener('click', (e) => {
      if (e.target.id === 'deleteCategoryModal') {
        closeDeleteModal()
      }
    })
    
    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal()
        closeEditModal()
        closeDeleteModal()
      }
    })
    
    // Add Category button
    document.querySelector('.btn-add-category').addEventListener('click', openModal)
    
    // Edit button functionality
    document.querySelectorAll('.btn-edit').forEach((btn) => {
      btn.addEventListener('click', () => {
        const row = btn.closest('tr')
        const categoryName = row.querySelector('.category-name').textContent
        const offerText = row.querySelector('.offer').textContent.trim()
        const offer = offerText.replace('%', '').replace('-', '')
        const status = row.querySelector('.status-text').textContent.toLowerCase()
    
        openEditModal({
          name: categoryName,
          offer: offer,
          status: status,
          description: ''
        })
      })
    })
    
    // Delete button functionality
    document.querySelectorAll('.btn-delete').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        const row = e.target.closest('tr')
        const categoryName = row.querySelector('.category-name').textContent
        const productCount = row.querySelector('.category-name').textContent === 'Leather' ? 124 : row.querySelector('.category-name').textContent === 'Flats' ? 85 : row.querySelector('.category-name').textContent === 'Heels' ? 156 : Math.floor(Math.random() * 200) + 50 // Random count for demo
    
        openDeleteModal(categoryName, productCount, row)
      })
    })
  </script>
{% endblock %}
